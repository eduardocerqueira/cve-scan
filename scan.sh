#!/bin/bash

# Read the pattern from the first argument, if provided
PATTERN="$1"

# Create the report directory if it doesn't exist
mkdir -p report

# Read each line from images.txt
while IFS= read -r line; do
    echo "$line"
    
    docker pull --platform linux/x86_64 "$line"

    if [[ -n "$PATTERN" && "$line" == *"$PATTERN"* ]]; then
        filename=$(echo "$line" | sed "s#$PATTERN.*##")
    else
        # Use the part after the last "/"
        filename=$(echo "$line" | awk -F '/' '{print $NF}')
    fi
    
    if [[ -n "$filename" ]]; then
        # Create a JSON file in the report directory with the filename
        echo "----"
        trivy image --format template --template "@trivy-template/html.tpl" -o "report/${filename}.html" "$line"
    fi

done < images.txt
